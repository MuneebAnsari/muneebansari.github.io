<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Verification Sent</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f4f4f4;
      }
      .container {
        text-align: center;
        padding: 20px;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 80%;
      }
      h1 {
        margin-bottom: 20px;
      }
      .link {
        display: inline;
        margin-top: 20px;
        color: #007bff;
        text-decoration: none;
      }
      img.logo {
        max-width: 25%;
        height: auto;
      }
      .button-link {
        background: none;
        border: none;
        color: #007bff;
        text-decoration: none;
        cursor: pointer;
        padding: 0;
        font: inherit;
      }
      .button-link:focus {
        outline: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <img
        src="https://engineeringcareers.utoronto.ca/files/2020/10/407-ETR-logo.jpg"
        alt="Logo"
        class="logo"
      />

      <p>
        A verification email has been sent. Please check your inbox and click
        the verification link to complete the process.
      </p>

      <button onclick="callback()">Continue</button>

      <p>
        Didn't get an email?
        <a class="link" onclick="callback()">Resend</a>
      </p>
      <p>
        Wrong email?
        <button class="button-link" onclick="logoutCallback()">Sign Out</button>
      </p>
    </div>
  </body>
  <script>
    function getState() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("state");
    }
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("session_token");
    }

    function goToContinueUri() {
      const receivedToken = getSessionToken();
      const updatedSessionToken = updatedToken(receivedToken);

      const continueUri = `https://login.mansar.io/continue?state=${getState()}&session_token=${updatedSessionToken}`;
      let iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = continueUri;
      document.body.appendChild(iframe);
    }

    function logoutCallback() {
      window.location.href =
        "com.etr407.ciam.androidharness://login.mansar.io/custom/logout";
    }

    function callback() {
      window.location.href =
        "com.etr407.ciam.androidharness://login.mansar.io/custom";
    }

    function updatedToken(receivedToken) {
      console.log("receivedToken", receivedToken);
      function decodeJwt(token) {
        const payload = token.split(".")[1];
        return JSON.parse(atob(payload.replace(/-/g, "+").replace(/_/g, "/")));
      }

      function signJwt(payload, secret) {
        const header = { alg: "HS256", typ: "JWT" };
        const headerEncoded = btoa(JSON.stringify(header)).replace(/=/g, "");
        const payloadEncoded = btoa(JSON.stringify(payload)).replace(/=/g, "");
        console.log(payloadEncoded);
        // const signature = btoa(headerEncoded + "." + payloadEncoded);
        return headerEncoded + "." + payloadEncoded + "." + secret;
      }

      let decodedPayload = decodeJwt(receivedToken);
      console.log(decodedPayload);
      decodedPayload = { status: "abc", ...decodedPayload };
      console.log(decodedPayload);
      const secret =
        "acec655005ad1288027db5d9cf1d232795b11894d8750aaa11e5b11102fa38f9";
      const updatedToken = signJwt(decodedPayload, secret);

      console.log("Updated Tokenn:", updatedToken);
      return updatedToken;
    }
  </script>
</html>
